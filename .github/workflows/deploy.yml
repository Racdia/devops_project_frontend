name: Deploy to AWS EC2

on:
  push:
    branches:
      - main  # Déploie quand on pousse sur la branche main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Aller dans le dossier du projet et récupérer les dernières mises à jour
            cd /var/www/dev_ops_project
            git pull origin main

            # Mettre à jour et builder le frontend
            cd /var/www/devops_project_frontend
            git pull origin main
            npm install
            npm run build --prod

            # Mettre à jour et exécuter les migrations du backend
            cd /var/www/dev_ops_project
            composer install --no-dev --optimize-autoloader
            php artisan migrate --force

            # Redémarrer les services si nécessaire
            sudo systemctl restart nginx
